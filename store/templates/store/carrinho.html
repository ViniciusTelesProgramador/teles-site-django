{% extends 'store/base.html' %}
{% load static %}

{% block title %}Carrinho de Compras - Teles{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-12">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">ðŸ›’ Carrinho de Compras</h1>

  {% if carrinho %}
  <form method="post" action="{% url 'atualizar_carrinho' %}" class="space-y-6">
    {% csrf_token %}
    <div class="bg-white shadow overflow-hidden rounded-xl border border-gray-200">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-100 text-gray-700 text-left">
          <tr>
            <th class="px-6 py-3">Produto</th>
            <th class="px-6 py-3">PreÃ§o</th>
            <th class="px-6 py-3">Quantidade</th>
            <th class="px-6 py-3">Subtotal</th>
            <th class="px-6 py-3">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for produto_id, item in carrinho.items %}
          <tr>
            <td class="px-6 py-4 font-medium text-gray-800">{{ item.nome }}</td>
            <td class="px-6 py-4 text-green-700 font-semibold">R$ {{ item.preco }}</td>
            <td class="px-6 py-4">
              <input 
                type="number"
                name="quantidade_{{ produto_id }}"
                value="{{ item.quantidade }}"
                min="1"
                class="w-16 border rounded-md px-2 py-1 text-center quantidade-input"
                data-produto-id="{{ produto_id }}"
              >
            </td>
            <td class="px-6 py-4 text-gray-800 font-medium">
              R$ {{ item.preco }} x {{ item.quantidade }} = R$ {{ item.subtotal|floatformat:2 }}
            </td>
            <td class="px-6 py-4">
              <a href="{% url 'remover_carrinho' produto_id %}" class="text-red-600 font-semibold hover:underline">Remover</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="flex items-center justify-between pt-4">
      <p class="text-lg font-semibold text-gray-800">Total: <span class="text-green-700">R$ {{ total|floatformat:2 }}</span></p>
      <div class="flex gap-3">
        <a href="{% url 'home' %}" class="bg-gray-500 hover:bg-gray-600 text-white font-medium px-4 py-2 rounded-md shadow">
          Continuar comprando
        </a>
        <a href="{% url 'checkout' %}" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-md shadow">
          Finalizar Pedido
        </a>
      </div>
    </div>
  </form>
  {% else %}
  <div class="bg-yellow-100 text-yellow-800 p-6 rounded-lg border border-yellow-300 shadow">
    Seu carrinho estÃ¡ vazio.
  </div>
  {% endif %}
</div>
<script>
document.querySelectorAll('.quantidade-input').forEach(input => {
  input.addEventListener('change', function () {
    const produtoId = this.dataset.produtoId;
    const quantidade = this.value;

    fetch("{% url 'atualizar_carrinho' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `quantidade_${produtoId}=${quantidade}`
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;  // recarrega a pÃ¡gina com valores atualizados
      }
    });
  });
});
</script>

{% endblock %}
