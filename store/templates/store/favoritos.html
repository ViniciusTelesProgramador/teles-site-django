{% extends 'store/base.html' %}
{% block title %}Meus Favoritos{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold mb-6">Meus Produtos Favoritos</h1>

  <div id="favoritos-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    {% for favorito in favoritos %}
      <div class="relative bg-white border rounded-lg shadow-md p-4" data-card>
        {% if user.is_authenticated %}
        <!-- NOTE: usa data-url para o handler global do base.html -->
        <a href="javascript:void(0);"
           class="toggle-favorito absolute top-2 right-2 text-xl"
           data-url="{% url 'toggle_favorito' favorito.produto.id %}">
          <i class="fa fa-heart text-red-500"></i>
        </a>
        {% endif %}

        <a href="{% url 'produto_detail' favorito.produto.id %}">
          {% if favorito.produto.imagem %}
            <img src="{{ favorito.produto.imagem.url }}" alt="{{ favorito.produto.nome }}" class="w-full h-48 object-contain mb-4">
          {% else %}
            <img src="https://via.placeholder.com/300x200?text=Sem+Imagem" class="w-full h-48 object-contain mb-4">
          {% endif %}
          <h2 class="text-lg font-semibold text-gray-800">{{ favorito.produto.nome }}</h2>
          <p class="text-sm text-gray-600">R$ {{ favorito.produto.get_preco_display }}</p>
        </a>
      </div>
    {% empty %}
      <p>Você ainda não favoritou nenhum produto.</p>
    {% endfor %}
  </div>
</div>

<script>
  // Usa o POST e o toast do base.html.
  // Aqui só fazemos a animação e removemos o card quando virar "desfavoritado".
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.toggle-favorito');
    if (!btn) return;

    const card = btn.closest('[data-card]');
    const icon = btn.querySelector('i');

    // Dá um tempinho pro handler global alternar as classes do ícone
    setTimeout(() => {
      const aindaFavoritado = icon.classList.contains('fa-solid');
      if (!aindaFavoritado && card) {
        // animação: fade + leve subida
        card.classList.add('transition-all','duration-300','ease-out');
        card.classList.add('opacity-0','-translate-y-2');

        setTimeout(() => {
          card.remove();

          // se ficou vazio, mostra mensagem
          const grid = document.getElementById('favoritos-grid');
          if (grid && grid.children.length === 0) {
            grid.insertAdjacentHTML('beforeend', '<p>Você ainda não favoritou nenhum produto.</p>');
          }
        }, 320); // bate com duration-300
      }
    }, 250);
  });
</script>

{% endblock %}
