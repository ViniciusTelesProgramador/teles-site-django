{% extends 'store/base.html' %}
{% load static %}

{% block title %}Cadastrar - Teles{% endblock %}

{% block content %}
<div class="max-w-md mx-auto py-12 px-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Criar conta</h1>

  {% if messages %}
    <ul class="mb-4">
      {% for message in messages %}
        <li class="text-sm text-{{ message.tags }}-600">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" class="space-y-4 bg-white p-6 rounded-lg shadow-md border border-gray-200" id="cadastro-form">
    {% csrf_token %}

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="first_name" class="block text-sm font-medium text-gray-700">Primeiro nome</label>
        <input type="text" id="first_name" name="first_name" required class="w-full border-gray-300 rounded-md shadow-sm mt-1 px-3 py-2">
      </div>
      <div>
        <label for="last_name" class="block text-sm font-medium text-gray-700">Sobrenome</label>
        <input type="text" id="last_name" name="last_name" required class="w-full border-gray-300 rounded-md shadow-sm mt-1 px-3 py-2">
      </div>
    </div>

    <div>
      <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
      <input type="email" id="email" name="email" required class="w-full border-gray-300 rounded-md shadow-sm mt-1 px-3 py-2">
    </div>

    <div>
      <label for="cep" class="block text-sm font-medium text-gray-700">CEP</label>
      <input type="text" id="cep" name="cep" required pattern="\d{5}-?\d{3}" maxlength="9" class="w-full border-gray-300 rounded-md shadow-sm mt-1 px-3 py-2">
    </div>

    <div>
      <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
      <div class="relative">
        <input type="password" id="password" name="password" required class="w-full border-gray-300 rounded-md shadow-sm mt-1 px-3 py-2 pr-10">
        <button type="button" onclick="togglePassword('password')" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500">👁️</button>
      </div>
      <div id="password-feedback" class="text-sm mt-1"></div>
    </div>

    <div>
      <label for="password2" class="block text-sm font-medium text-gray-700">Confirmar senha</label>
      <div class="relative">
        <input type="password" id="password2" name="password2" required class="w-full border-gray-300 rounded-md shadow-sm mt-1 px-3 py-2 pr-10">
        <button type="button" onclick="togglePassword('password2')" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500">👁️</button>
      </div>
      <div id="match-feedback" class="text-sm mt-1"></div>
    </div>

    <!-- reCAPTCHA v2 -->
    <div class="g-recaptcha mt-4" data-sitekey="{{ recaptcha_site_key }}"></div>

    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-md mt-4">Cadastrar</button>
  </form>

  <p class="text-xs text-gray-500 mt-4 text-center">
    Este site é protegido pelo reCAPTCHA e está sujeito à
    <a href="https://policies.google.com/privacy" target="_blank" class="underline">Política de Privacidade</a> e
    <a href="https://policies.google.com/terms" target="_blank" class="underline">Termos de Serviço</a> do Google.
  </p>

  <p class="text-center text-sm text-gray-600 mt-4">
    Já tem conta? <a href="{% url 'login' %}" class="text-blue-600 hover:underline">Entrar</a>
  </p>
</div>

<!-- reCAPTCHA v2 Script -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<!-- Validação de senha -->
<script>
  function togglePassword(id) {
    const field = document.getElementById(id);
    field.type = field.type === "password" ? "text" : "password";
  }

  document.addEventListener("DOMContentLoaded", function () {
    const password = document.getElementById("password");
    const password2 = document.getElementById("password2");
    const feedback = document.getElementById("password-feedback");
    const matchFeedback = document.getElementById("match-feedback");

    function validatePasswordStrength(pwd) {
      const length = pwd.length >= 8;
      const upper = /[A-Z]/.test(pwd);
      const lower = /[a-z]/.test(pwd);
      const number = /[0-9]/.test(pwd);
      const symbol = /[\W_]/.test(pwd);

      if (!pwd) {
        feedback.textContent = "";
        return;
      }

      if (length && upper && lower && number && symbol) {
        feedback.textContent = "Senha forte ✔️";
        feedback.className = "text-green-600 text-sm mt-1";
      } else {
        feedback.textContent = "A senha deve ter no mínimo 8 caracteres, incluindo maiúscula, minúscula, número e símbolo.";
        feedback.className = "text-red-600 text-sm mt-1";
      }
    }

    function validatePasswordMatch() {
      if (!password2.value) {
        matchFeedback.textContent = "";
        return;
      }

      if (password.value === password2.value) {
        matchFeedback.textContent = "As senhas coincidem ✔️";
        matchFeedback.className = "text-green-600 text-sm mt-1";
      } else {
        matchFeedback.textContent = "As senhas não coincidem ❌";
        matchFeedback.className = "text-red-600 text-sm mt-1";
      }
    }

    password.addEventListener("input", () => {
      validatePasswordStrength(password.value);
      validatePasswordMatch();
    });

    password2.addEventListener("input", validatePasswordMatch);
  });
</script>
{% endblock %}
