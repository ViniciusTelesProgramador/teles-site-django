{% extends 'store/base.html' %}
{% load static %}

{% block title %}Finalizar Pedido{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold mb-6">Finalizar Pedido</h1>

  <div class="bg-white p-6 rounded shadow mb-8">
    <h2 class="text-lg font-semibold mb-4">Resumo do Carrinho</h2>
    {% for item in carrinho.values %}
      <p>{{ item.nome }} ({{ item.quantidade }} x R$ {{ item.preco|floatformat:2 }})</p>
    {% endfor %}
    <p class="text-green-600 font-bold mt-4">Total: R$ {{ total|floatformat:2 }}</p>

    {% if entrega_gratis %}
      <p class="text-blue-600 mt-2 flex items-center gap-1">
        <span>ðŸŽ‰</span> VocÃª ganhou entrega grÃ¡tis para SÃ£o LuÃ­s!
      </p>
    {% endif %}
  </div>

  <!-- âœ… FormulÃ¡rio de checkout (dados do pedido) -->
  <form method="post" class="bg-white p-6 rounded shadow space-y-4">
    {% csrf_token %}

    <div>
      <label class="block font-semibold">Nome:</label>
      {{ form.nome }}
    </div>

    <div>
      <label class="block font-semibold">Email:</label>
      {{ form.email }}
    </div>

    <div>
      <label class="block font-semibold">CEP:</label>
      {{ form.cep }}
    </div>

{% if form.opcao_entrega %}
  <div>
    <label class="block font-semibold mb-1">Como deseja receber:</label>
    {{ form.opcao_entrega }}
  </div>
{% endif %}

{# retirada #}
{% if form.loja_retirada %}
  <div id="loja-retirada-campo" style="display:none">
    <label class="block font-semibold">{{ form.loja_retirada.label }}</label>
    {{ form.loja_retirada }}
    {% for err in form.loja_retirada.errors %}<p class="text-red-600 text-sm">{{ err }}</p>{% endfor %}
  </div>
{% endif %}

{# ENTREGA: endereÃ§o detalhado #}
<div id="bloco-endereco" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="display:none">
  <div>
    <label class="block font-semibold" for="{{ form.rua.id_for_label }}">Rua</label>
    {{ form.rua }}
    {% for err in form.rua.errors %}<p class="text-red-600 text-sm">{{ err }}</p>{% endfor %}
  </div>
  <div>
    <label class="block font-semibold" for="{{ form.numero.id_for_label }}">NÃºmero</label>
    {{ form.numero }}
    {% for err in form.numero.errors %}<p class="text-red-600 text-sm">{{ err }}</p>{% endfor %}
  </div>
  <div>
    <label class="block font-semibold" for="{{ form.bairro.id_for_label }}">Bairro</label>
    {{ form.bairro }}
    {% for err in form.bairro.errors %}<p class="text-red-600 text-sm">{{ err }}</p>{% endfor %}
  </div>
  <div>
    <label class="block font-semibold" for="{{ form.telefone_contato.id_for_label }}">Telefone para contato</label>
    {{ form.telefone_contato }}
    {% for err in form.telefone_contato.errors %}<p class="text-red-600 text-sm">{{ err }}</p>{% endfor %}
  </div>
  <div class="md:col-span-2">
    <label class="block font-semibold" for="{{ form.ponto_referencia.id_for_label }}">Ponto de referÃªncia</label>
    {{ form.ponto_referencia }}
    {% for err in form.ponto_referencia.errors %}<p class="text-red-600 text-sm">{{ err }}</p>{% endfor %}
  </div>
</div>


    <div class="flex gap-4 mt-6">
      <a href="{% url 'carrinho' %}" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
        Voltar ao carrinho
      </a>
    </div>
  </form>

  <!-- âœ… FormulÃ¡rio separado para pagamento com Mercado Pago, fora do form principal -->
  <div class="mt-6">
    <form action="{% url 'checkout_mercado_pago' %}" method="post">
      {% csrf_token %}
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded w-full">
        Pagar com Mercado Pago
      </button>
    </form>
  </div>
</div>

<!-- Scripts para mostrar/esconder campos -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const radios = document.querySelectorAll('input[name="opcao_entrega"]');
    const blocoEndereco = document.getElementById('bloco-endereco');
    const campoLoja = document.getElementById('loja-retirada-campo');

    function atualiza() {
      const r = document.querySelector('input[name="opcao_entrega"]:checked');
      if (!r) return;
      const isEntrega = r.value === 'entrega';
      const isRetirada = r.value === 'retirada';
      if (blocoEndereco) blocoEndereco.style.display = isEntrega ? 'grid' : 'none';
      if (campoLoja) campoLoja.style.display = isRetirada ? 'block' : 'none';
    }
    atualiza();
    radios.forEach(el => el.addEventListener('change', atualiza));
  });
</script>

{% endblock %}
